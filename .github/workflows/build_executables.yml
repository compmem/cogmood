name: Build Executables

on:
    push:
        branches: [actions-development]
    pull_request:
        branches: [actions-development]

jobs:
    build-windows:
        runs-on: windows-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive # Initializes and updates submodules

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10" # Specify your Python version
                  cache: 'pip' # caching pip dependencies

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Set up Mesa3D OpenGL DLL
              run: |
                  curl -L -o opengl32.dll https://github.com/pal1000/mesa-dist-win/releases/download/22.1.5/mesa3d-22.1.5-release-mingw.7z
                  7z x mesa3d-22.1.5-release-mingw.7z -o$Env:UserProfile\mesa3d
              shell: pwsh
            
            - name: Add Mesa3D to Path
              run: |
                  echo "$Env:UserProfile\mesa3d\mesa3d-22.1.5-release-mingw\libglapi.dll" >> $Env:Path
                  echo "$Env:UserProfile\mesa3d\mesa3d-22.1.5-release-mingw\opengl32.dll" >> $Env:Path
              shell: pwsh

            - name: Build executable with PyInstaller
              run: |
                  cd package
                  pyinstaller --noconfirm --upx-dir upx/windows_upx.exe cogmood_windows.spec

            - name: Upload Windows executable
              uses: actions/upload-artifact@v4
              with:
                  name: SUPREME
                  path: dist/SUPREME.exe # Path to your Windows executable

    build-macos:
        runs-on: macos-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  submodules: recursive # Initializes and updates submodules

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10" # Specify your Python version

            - name: Install Homebrew dependencies
              run: |
                  brew update
                  brew install sdl2 sdl2_image sdl2_mixer sdl2_ttf

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Build executable with PyInstaller
              run: |
                  cd package
                  pyinstaller --noconfirm cogmood_mac.spec

            - name: Upload macOS executable
              uses: actions/upload-artifact@v4
              with:
                  name: SUPREME
                  path: dist/SUPREME
